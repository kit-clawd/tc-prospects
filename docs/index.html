<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TC Prospects - District Browser</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; margin-bottom: 5px; }
        .subtitle { color: #666; margin-bottom: 20px; }
        
        .filters {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .filters label { font-weight: 500; color: #555; }
        .filters select, .filters input {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .filters input[type="text"] { width: 200px; }
        .filters input[type="checkbox"] { width: auto; margin-right: 5px; }
        
        .stats {
            background: #e8f4fd;
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            color: #1a73e8;
            font-size: 14px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: #fafafa;
            font-weight: 600;
            color: #333;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }
        th:hover { background: #f0f0f0; }
        th.sorted-asc::after { content: ' â†‘'; }
        th.sorted-desc::after { content: ' â†“'; }
        
        tr.district-row { cursor: pointer; }
        tr.district-row:hover { background: #f8f9fa; }
        tr.expanded { background: #f0f7ff; }
        
        .enrollment { font-weight: 500; }
        .enrollment.large { color: #1a73e8; }
        .enrollment.medium { color: #34a853; }
        .enrollment.small { color: #666; }
        
        .amount {
            font-family: monospace;
            font-size: 13px;
        }
        .amount.high { color: #ea4335; font-weight: 500; }
        
        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .type-badge.Urban { background: #e8f0fe; color: #1967d2; }
        .type-badge.Suburban { background: #e6f4ea; color: #137333; }
        .type-badge.Rural { background: #fef7e0; color: #b06000; }
        
        .recent-badge {
            display: inline-block;
            background: #34a853;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 500;
        }
        
        .detail-row {
            display: none;
        }
        .detail-row.visible {
            display: table-row;
        }
        .detail-row td {
            background: #fafbfc;
            padding: 15px 20px;
        }
        
        .award-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .award-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
        }
        .award-list li:last-child { border-bottom: none; }
        .award-program {
            font-weight: 500;
            color: #333;
        }
        .award-desc {
            color: #666;
            font-size: 13px;
            flex: 1;
        }
        .award-amount {
            font-family: monospace;
            font-weight: 500;
            color: #1a73e8;
            white-space: nowrap;
        }
        .award-date {
            color: #999;
            font-size: 12px;
        }
        
        .no-awards {
            color: #999;
            font-style: italic;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        footer {
            margin-top: 30px;
            text-align: center;
            color: #999;
            font-size: 12px;
        }
        
        .expand-icon {
            color: #999;
            margin-right: 8px;
            transition: transform 0.2s;
            display: inline-block;
        }
        .expanded .expand-icon {
            transform: rotate(90deg);
        }
    </style>
</head>
<body>
    <h1>ðŸŽ¯ TC Prospects</h1>
    <p class="subtitle">School district prospecting browser â€” click a row to see award details</p>
    
    <div class="filters">
        <div>
            <label>State:</label>
            <select id="stateFilter">
                <option value="">All States</option>
            </select>
        </div>
        <div>
            <label>Type:</label>
            <select id="typeFilter">
                <option value="">All Types</option>
                <option value="Urban">Urban</option>
                <option value="Suburban">Suburban</option>
                <option value="Rural">Rural</option>
            </select>
        </div>
        <div>
            <label>Min Enrollment:</label>
            <select id="enrollmentFilter">
                <option value="0">Any</option>
                <option value="5000">5,000+</option>
                <option value="10000">10,000+</option>
                <option value="25000">25,000+</option>
                <option value="50000">50,000+</option>
                <option value="100000">100,000+</option>
            </select>
        </div>
        <div>
            <label><input type="checkbox" id="titleIFilter"> Has Title I</label>
        </div>
        <div>
            <label><input type="checkbox" id="recentFilter"> Recent Awards (2025+)</label>
        </div>
        <div>
            <label>Search:</label>
            <input type="text" id="searchFilter" placeholder="District name...">
        </div>
    </div>
    
    <div class="stats" id="stats"></div>
    
    <table id="districtsTable">
        <thead>
            <tr>
                <th data-sort="name">District</th>
                <th data-sort="state">State</th>
                <th data-sort="city">City</th>
                <th data-sort="type">Type</th>
                <th data-sort="enrollment">Enrollment</th>
                <th data-sort="federal_awards">Total Awards</th>
                <th data-sort="title_i">Title I</th>
                <th data-sort="recent_awards">Recent</th>
            </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
    </table>
    
    <footer>
        Data sources: NCES, USASpending.gov | Last updated: <span id="lastUpdated">-</span>
    </footer>

    <script>
        let allDistricts = [];
        let currentSort = { field: 'enrollment', direction: 'desc' };
        let expandedRows = new Set();
        
        async function loadData() {
            try {
                const resp = await fetch('data.json');
                const data = await resp.json();
                allDistricts = data.districts || [];
                
                // Populate state filter
                const states = [...new Set(allDistricts.map(d => d.state))].sort();
                const stateSelect = document.getElementById('stateFilter');
                states.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s;
                    opt.textContent = s;
                    stateSelect.appendChild(opt);
                });
                
                // Update timestamp
                if (data.meta?.updated) {
                    document.getElementById('lastUpdated').textContent = 
                        new Date(data.meta.updated).toLocaleDateString();
                }
                
                renderTable();
            } catch (e) {
                console.error('Failed to load data:', e);
                document.getElementById('tableBody').innerHTML = 
                    '<tr><td colspan="8" class="empty-state">Failed to load data. Run fetch_data.py first.</td></tr>';
            }
        }
        
        function getFilteredDistricts() {
            const state = document.getElementById('stateFilter').value;
            const type = document.getElementById('typeFilter').value;
            const minEnrollment = parseInt(document.getElementById('enrollmentFilter').value) || 0;
            const search = document.getElementById('searchFilter').value.toLowerCase();
            const titleIOnly = document.getElementById('titleIFilter').checked;
            const recentOnly = document.getElementById('recentFilter').checked;
            
            return allDistricts.filter(d => {
                if (state && d.state !== state) return false;
                if (type && d.type !== type) return false;
                if (d.enrollment && d.enrollment < minEnrollment) return false;
                if (search && !d.name.toLowerCase().includes(search)) return false;
                if (titleIOnly && (!d.title_i || d.title_i <= 0)) return false;
                if (recentOnly && (!d.recent_awards || d.recent_awards <= 0)) return false;
                return true;
            });
        }
        
        function sortDistricts(districts) {
            const { field, direction } = currentSort;
            return [...districts].sort((a, b) => {
                let aVal = a[field] ?? '';
                let bVal = b[field] ?? '';
                
                // Handle nulls - push to bottom
                if (aVal === null || aVal === '') aVal = direction === 'asc' ? Infinity : -Infinity;
                if (bVal === null || bVal === '') bVal = direction === 'asc' ? Infinity : -Infinity;
                
                if (typeof aVal === 'number' || typeof bVal === 'number') {
                    aVal = Number(aVal) || 0;
                    bVal = Number(bVal) || 0;
                    return direction === 'asc' ? aVal - bVal : bVal - aVal;
                }
                return direction === 'asc' 
                    ? String(aVal).localeCompare(String(bVal))
                    : String(bVal).localeCompare(String(aVal));
            });
        }
        
        function formatMoney(amount) {
            if (!amount || amount <= 0) return '-';
            if (amount >= 1000000) return `$${(amount/1000000).toFixed(1)}M`;
            if (amount >= 1000) return `$${(amount/1000).toFixed(0)}K`;
            return `$${amount.toFixed(0)}`;
        }
        
        function renderContacts(contacts) {
            if (!contacts || contacts.length === 0) {
                return '<p class="no-awards">No contacts found</p>';
            }
            
            const items = contacts.map(c => `
                <li>
                    <div>
                        <div class="award-program">${c.name || 'Unknown'}</div>
                        <div class="award-desc">${c.title || ''}</div>
                    </div>
                    <div style="text-align: right;">
                        ${c.email ? `<a href="mailto:${c.email}">${c.email}</a>` : ''}
                        ${c.phone ? `<div class="award-date">${c.phone}</div>` : ''}
                    </div>
                </li>
            `).join('');
            
            return `<ul class="award-list">${items}</ul>`;
        }
        
        function renderAwardDetails(awards, totalCount) {
            if (!awards || awards.length === 0) {
                return '<p class="no-awards">No detailed award data available</p>';
            }
            
            const items = awards.map(a => `
                <li>
                    <div>
                        <div class="award-program">${a.program || 'Federal Grant'}</div>
                        <div class="award-desc">${a.description || ''}</div>
                        ${a.start_date ? `<div class="award-date">${a.start_date}</div>` : ''}
                    </div>
                    <div class="award-amount">${formatMoney(a.amount)}</div>
                </li>
            `).join('');
            
            const countNote = (totalCount && totalCount > awards.length) 
                ? `<p style="color:#666;font-size:12px;margin-top:8px;">Showing top ${awards.length} of ${totalCount} awards</p>`
                : '';
            
            return `<ul class="award-list">${items}</ul>${countNote}`;
        }
        
        function toggleRow(districtId) {
            if (expandedRows.has(districtId)) {
                expandedRows.delete(districtId);
            } else {
                expandedRows.add(districtId);
            }
            renderTable();
        }
        
        function renderTable() {
            const filtered = getFilteredDistricts();
            const sorted = sortDistricts(filtered);
            
            // Update stats
            const totalEnrollment = sorted.reduce((sum, d) => sum + (d.enrollment || 0), 0);
            const totalAwards = sorted.reduce((sum, d) => sum + (d.federal_awards || 0), 0);
            const totalTitleI = sorted.reduce((sum, d) => sum + (d.title_i || 0), 0);
            document.getElementById('stats').innerHTML = 
                `Showing <strong>${sorted.length}</strong> districts | ` +
                `Enrollment: <strong>${totalEnrollment.toLocaleString()}</strong> | ` +
                `Total Awards: <strong>${formatMoney(totalAwards)}</strong> | ` +
                `Title I: <strong>${formatMoney(totalTitleI)}</strong>`;
            
            // Update sort indicators
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.dataset.sort === currentSort.field) {
                    th.classList.add(`sorted-${currentSort.direction}`);
                }
            });
            
            // Render rows
            const tbody = document.getElementById('tableBody');
            if (sorted.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="empty-state">No districts match your filters</td></tr>';
                return;
            }
            
            let html = '';
            sorted.forEach((d, idx) => {
                const districtId = `district-${idx}`;
                const isExpanded = expandedRows.has(districtId);
                const enrollmentClass = d.enrollment >= 50000 ? 'large' : d.enrollment >= 10000 ? 'medium' : 'small';
                const awardClass = d.federal_awards >= 10000000 ? 'high' : '';
                const titleIClass = d.title_i >= 5000000 ? 'high' : '';
                
                html += `
                    <tr class="district-row ${isExpanded ? 'expanded' : ''}" onclick="toggleRow('${districtId}')">
                        <td><span class="expand-icon">â–¶</span><strong>${d.name}</strong></td>
                        <td>${d.state}</td>
                        <td>${d.city || '-'}</td>
                        <td>${d.type ? `<span class="type-badge ${d.type}">${d.type}</span>` : '-'}</td>
                        <td class="enrollment ${enrollmentClass}">${d.enrollment?.toLocaleString() || '-'}</td>
                        <td class="amount ${awardClass}">${formatMoney(d.federal_awards)}</td>
                        <td class="amount ${titleIClass}">${formatMoney(d.title_i)}</td>
                        <td>${d.recent_awards ? `<span class="recent-badge">${d.recent_awards} new</span>` : '-'}</td>
                    </tr>
                    <tr class="detail-row ${isExpanded ? 'visible' : ''}" id="${districtId}-details">
                        <td colspan="8">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                                <div>
                                    <strong>ðŸ“§ Contacts:</strong>
                                    ${renderContacts(d.contacts)}
                                </div>
                                <div>
                                    <strong>ðŸ’° Award Details:</strong>
                                    ${renderAwardDetails(d.award_details, d.recent_awards)}
                                </div>
                            </div>
                            ${d.website ? `<div style="margin-top: 10px;"><a href="${d.website}" target="_blank">ðŸ”— District Website</a></div>` : ''}
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }
        
        // Event listeners
        document.querySelectorAll('.filters select, .filters input').forEach(el => {
            el.addEventListener('change', renderTable);
            el.addEventListener('input', renderTable);
        });
        
        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const field = th.dataset.sort;
                if (currentSort.field === field) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.field = field;
                    currentSort.direction = field === 'name' ? 'asc' : 'desc';
                }
                renderTable();
            });
        });
        
        // Load on start
        loadData();
    </script>
</body>
</html>
<!-- Tue Feb  3 05:12:53 PM UTC 2026 -->
